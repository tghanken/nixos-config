# nixos-config

NixOS configuration for home devices using [blueprint](https://github.com/numtide/blueprint).

## Structure

```
.
├── flake.nix           # Main flake using blueprint
├── hosts/              # Host configurations (auto-discovered by blueprint)
│   ├── desktops/       # Desktop machines
│   │   ├── inwin-tower/
│   │   └── nixos-thinkpad/
│   ├── servers/        # Server machines
│   │   ├── nixos-rpi3/
│   │   ├── nixos-rpi4-1/
│   │   ├── nixos-rpi4-2/
│   │   ├── nixos-rpi4-3/
│   │   └── syno-vm/
│   └── utils/          # Utility configurations
│       └── nixos-bootstrap/
├── modules/            # Shared NixOS modules
│   ├── profiles/       # Profile hierarchy
│   │   ├── bootstrap.nix   # Base profile
│   │   ├── install.nix     # + disko
│   │   ├── common.nix      # + secrets
│   │   ├── server.nix      # Server profile
│   │   └── desktop.nix     # Desktop profile + home-manager
│   ├── bootstrap/      # Bootstrap modules
│   ├── common/         # Common modules
│   ├── desktop/        # Desktop-specific modules
│   ├── hardware/       # Hardware modules
│   ├── install/        # Installation modules
│   ├── server/         # Server modules
│   └── users/          # User configurations
├── packages/           # Custom packages (auto-discovered)
├── devshells/          # Development shells (auto-discovered)
├── formatter/          # Code formatter (auto-discovered)
├── checks/             # CI checks (auto-discovered)
└── secrets/            # Agenix secrets
```

## Profile Hierarchy

```
bootstrap (base)
    └── install (+disko)
            └── common (+secrets)
                    ├── server
                    └── desktop (+home-manager)
```

## Usage

### Build a host configuration
```bash
nixos-rebuild switch --flake .#<hostname>
```

### Enter development shell
```bash
nix develop
```

### Format code
```bash
nix fmt
```

### Run checks
```bash
nix flake check
```

### Build bootstrap images
```bash
# x86_64 ISO image
nix build .#nixos-vm-bootstrap-image

# aarch64 SD card image for Raspberry Pi
nix build .#nixos-rpi-bootstrap-image
```

## Adding a New Host

1. Create a new directory under `hosts/desktops/` or `hosts/servers/`
2. Add a `default.nix` that imports the appropriate profile:
   - For desktops: `../../../modules/profiles/desktop.nix`
   - For servers: `../../../modules/profiles/server.nix`
3. Add `hardware-configuration.nix` (generated by `nixos-generate-config`)
4. Configure host-specific options (hostname, hostId, etc.)
